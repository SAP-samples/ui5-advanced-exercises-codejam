# Chapter 05 - Custom Controls and Third-Party Packages

By the end of this chapter we will have built a custom control that uses a third-party package ([Three.js](https://www.npmjs.com/package/three)) and allows users to visually explore the supermarket in a 3D model and find a selected product.

## Steps

- [1. Move 3D model into the application](#0-copy-3d-model-into-the-application)<br>
- [2. Install required dependencies](#1-install-required-dependencies)<br>
- [3. Create custom control skeleton](#2-create-custom-control-skeleton)<br>
- [4. Define metadata and private variables](#3-define-metadata-and-private-variables)<br>
- [5. Add lifecycle logic](#4-add-lifecycle-logic)<br>
- [6. Add control specific methods](#5-add-control-specific-methods)<br>
- [7. Add the renderer](#6-add-the-renderer)<br>
- [8. Use the custom control](#7-use-the-custom-control)<br>
- [9. Add CSS stylng](#8-add-css-styling)<br>
- [10. Use custom control methods in controller](#9-use-custom-control-methods-in-controller)<br>
- [11. Test the custom control](#10-test-the-custom-control)<br>

### 1. Move 3D model into the application

Before the start with custom control development, let's provide the supermarket 3D model to the application.

➡️ Move the `application/uimodule/webapp/supermarket.glb` file (from the sample application included in this repo) into the `codejam.supermarket/uimodule/webapp` directory. You can do this via your file explorer or use this command:

```bash
mv ../application/uimodule/webapp/supermarket.glb uimodule/webapp/
```

### 2. Install required dependencies

➡️ Run the following command in the `codejam.supermarket/uimodule` directory:

```bash
npm i ui5-tooling-modules @ui5/ts-interface-generator -D
```

```bash
npm i three gsap
```

We installed [`ui5-tooling-modules`](https://www.npmjs.com/package/ui5-tooling-modules) and [`@ui5/ts-interface-generator`](https://www.npmjs.com/package/@ui5/ts-interface-generator) as development dependencies (`-D`), as we will only require them during design time. The `ui5-tooling-modules` provides a middleware (and task) that let's us use NPM packages directly inside our UI5 app. We need this kind of middleware due to UI5's architectural independence from Node.js (UI5 apps can run on any server that serves static file). The `@ui5/ts-interface-generator` is required for custom control development and generates TypeScript interfaces which declare the methods generated by UI5 only at runtime.

We also installed the (non-development) dependencies `[three](https://www.npmjs.com/package/three)` and `[gsap](https://www.npmjs.com/package/gsap)`, which are required for the custom control we will build. Three.js is a popular JavaScript library for creating 3D graphics, and `gsap` is a powerful animation library that we will use to animate the 3D model of the supermarket.

### 3. Create custom control skeleton

We can now get into the actual control development. Our custom control will essentially be only one file. Let's create the skeleton first and later fill in the details step-by-step.

➡️ Create a new file `codejam.supermarket/uimodule/webapp/ext/control/Supermarket.ts` with the following content:

```typescript
import Control from "sap/ui/core/Control"
import RenderManager from "sap/ui/core/RenderManager"
import { MetadataOptions } from "sap/ui/core/Element"
import {
	Scene,
	PerspectiveCamera,
	WebGLRenderer,
	AmbientLight
} from "three"
import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader'
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls'
import gsap from "gsap"
import BusyIndicator from "sap/m/BusyIndicator"
import Button from "sap/m/Button"

/**
 * @namespace uimodule.ext.control
 */
export default class Supermarket extends Control {

	static readonly metadata: MetadataOptions = {
		properties: {},
		aggregations: {}
	}

    // placeholder for some private variables

	init(): void {}

	onAfterRendering(): void {}

	private animate(): void {}

	public setCameraPosition(): void {}

	public expand(): void {}

	static renderer = {
		apiVersion: 4,
		render: (rm: RenderManager, control: Supermarket) => {}
	}
}
```

Our custom control extends UI5's base class control (`sap/ui/core/Control`), which means it inherits all of its methods (incl. the lifecycle methods `init()` and `onAfterRendering()`) and core capabilities. We also add more `metadata` and other methods specific to our custom control. Most importantly, we define a `renderer` for our custom control, which will include the rendered html elements that make up the control.

### 4. Define metadata and private variables

➡️ Replace the `metadata` and the `// placeholder for some private variables` in the `codejam.supermarket/uimodule/webapp/ext/control/Supermarket.ts` file with the following code:

```typescript
	static readonly metadata: MetadataOptions = {
		properties: {
			x: { type: "float", defaultValue: 20.69 },
			y: { type: "float", defaultValue: 10.12 },
			z: { type: "float", defaultValue: -28.03 },
			growFactor: { type: "float", defaultValue: 2 }
		},
		aggregations: {
			_busyIndicator: {
				type: "sap.m.BusyIndicator",
				multiple: false
			},
			_expand: {
				type: "sap.m.Button",
				multiple: false
			}
		}
	}

	private scene: Scene
	private camera: PerspectiveCamera
	private threeRenderer: WebGLRenderer
	private controls: OrbitControls
	private animationSpeed = 3000
	private height: Number
	private width: Number
```

### 5. Add lifecycle logic

➡️ Replace the `init()` and `onAfterRendering()` methods in the `codejam.supermarket/uimodule/webapp/ext/control/Supermarket.ts` file with the following code:

```typescript
	init(): void {
		this.setAggregation("_busyIndicator", new BusyIndicator({
			visible: true
		}))
		this.setAggregation("_expand", new Button({
			icon: "sap-icon://full-screen",
			press: this.expand.bind(this, {})
		}))
	}

	onAfterRendering(): void {
		const canvas = this.getDomRef() as HTMLCanvasElement;
		const { width, height } = canvas.getBoundingClientRect()

		this.height = height
		this.width = width

		this.threeRenderer = new WebGLRenderer({
			canvas: canvas,
		})
		this.threeRenderer.setSize(width, height)

		this.scene = new Scene()
		this.camera = new PerspectiveCamera(75, width / height, 0.1, 1000)

		const ambientLight = new AmbientLight(0xffffff)
		this.scene.add(ambientLight)

		const loader = new GLTFLoader()
		loader.load("supermarket.glb", gltf => {
			this.scene.add(gltf.scene)
			this.setCameraPosition([{ x: 18.88, y: 2.44, z: -5.2 }], {})
			const busyIndicator = this.getAggregation("_busyIndicator") as BusyIndicator
			busyIndicator.setVisible(false)
		})

		this.controls = new OrbitControls(this.camera, this.threeRenderer.domElement)

		this.animate()

		this.camera.position.set(this.getX(), this.getY(), this.getZ())
	}
```

### 6. Add control specific methods

➡️ Add the following methods to the `codejam.supermarket/uimodule/webapp/ext/control/Supermarket.ts` file:

```typescript
	private animate(): void {
		this.threeRenderer.render(this.scene, this.camera)
		this.controls.update()
		requestAnimationFrame(this.animate.bind(this))
	}

	public setCameraPosition(coordinates: Array<Object>, { backToStart = false }: { backToStart?: Boolean }): void {
		if (backToStart) {
			this.camera.position.set(18.88, 2.44, -5.2)
		}
		gsap.to(this.camera.position, { ...coordinates[0], duration: this.animationSpeed / 1000 })
		for (let i = 1; i < coordinates.length; i++) {
			window.setTimeout(() => {
				gsap.to(this.camera.position, { ...coordinates[i], duration: this.animationSpeed / 1000 })
			}, this.animationSpeed)
		}
	}

	public expand({ stayExpanded = false }: { stayExpanded?: Boolean }): void {
		const expand = this.getAggregation("_expand") as Button
		const growFactor = this.getGrowFactor()
		const icon = expand.getIcon()
		const factor = icon === "sap-icon://full-screen" || stayExpanded ? growFactor : 1
		// @ts-ignore
		this.getParent().getDomRef().style.height = `${this.height * factor}px`
		// @ts-ignore
		this.getParent().getDomRef().style.width = `${this.width * factor}px`
		// @ts-ignore
		this.threeRenderer.setSize(this.width * factor, this.height * factor)
		expand.setIcon(`sap-icon://${factor === growFactor ? "exit-" : ""}full-screen`)
	}
```

Notice there are private and public methods...

### 7. Add the renderer

➡️ Replace the `renderer` in the `codejam.supermarket/uimodule/webapp/ext/control/Supermarket.ts` file with the following code:

```typescript
	static renderer = {
		apiVersion: 4,
		render: (rm: RenderManager, control: Supermarket) => {
			rm.openStart("canvas", control)
			rm.style("height", "100%")
			rm.style("width", "100%")
			rm.openEnd()
			rm.close("canvas")
			rm.openStart("div")
			rm.style("position", "absolute")
			rm.style("top", "0")
			rm.style("width", "100%")
			rm.style("height", "100%")
			rm.style("display", "flex")
			rm.style("align-items", "center")
			rm.style("justify-content", "center")
			rm.style("pointer-events", "none")
			rm.openEnd()
			rm.renderControl(control.getAggregation("_busyIndicator") as Control)
			rm.close("div")
			rm.openStart("div")
			rm.style("position", "absolute")
			rm.style("top", "0.5rem")
			rm.style("left", "0.5rem")
			rm.openEnd()
			rm.renderControl(control.getAggregation("_expand") as Control)
			rm.close("div")
		}
	}
```

### 8. Use the custom control

Now that we have our custom control ready, we can use it in our UI5 app.

```xml
			<FlexBox class="fixed">
				<cc:Supermarket id="supermarket" growFactor="2" />
			</FlexBox>
```

```xml
xmlns:cc="uimodule.ext.control"
```

### 9. Add CSS stylng

➡️ Create a new file `codejam.supermarket/uimodule/webapp/css/style,css` with the following content:

```css
.fixed {
	position: fixed;
	display: flex;
	bottom: 1rem;
	right: 1rem;
	height: 200px;
	width: 400px;

	justify-content: center;
	border-radius: 1rem;
	overflow: hidden;
	z-index: 9999;
}
```

### 10. Use custom control methods in controller

➡️ Add the following code to the `codejam.supermarket/uimodule/webapp/ext/main/Main.controller.ts` file:

```typescript
	public onFlyToProduct(event: Button$PressEvent): void {
		const source = event.getSource()
		const context = source.getBindingContext()
		const position = context?.getProperty("position")
		const supermarket = this.getView()?.byId("supermarket") as Supermarket
		supermarket.expand({ stayExpanded: true })
		supermarket.setCameraPosition(JSON.parse(position), { backToStart: true })
	}
```

With this method (which is invoked on the `press` event of the product tiles - check the xml view), we can fly to a specific product in the 3D model. For that, we first get the data for the position of the product from its context, and then use this data for the `setCameraPosition` method (after using `expand`) of our supermarket custom control.

If you feel like it, you can test the code completion (powered by TypeScript) by typing `supermarket.` at the end of the method. You should see all available methods (obviously only the public ones) plus their documentation inside your IDE. Pretty nice, isn't it?

### 11. Test the custom control








https://ui5.sap.com/#/topic/8dcab0011d274051808f959800cabf9f

https://ui5.sap.com/#/topic/4549da61e2d949d6a3d20ad8a9d17a6f
